# Hello-vertx

<!-- ../../okapi/doc/md2toc -l 2 -h 4 README.md -->
* [Introduction](#introduction)
* [Files](#files)
* [Compiling](#compiling)
* [Docker](#docker)
* [Installing the module](#installing-the-module)
* [Deploying the module](#deploying-the-module)
* [Using the module](#using-the-module)
* [Restrict access](#restrict-access)
* [Cleaning up](#cleaning-up)
    * [Disable the module for the tenant](#disable-the-module-for-the-tenant)
    * [Undeploy the module](#undeploy-the-module)
    * [Undeclaring the module](#undeclaring-the-module)
* [Scripting it](#scripting-it)
* [What next](#what-next)

## Introduction

A minimal "Hello, world" module written in Java, using the Vert.x framework, the same tools as we
use for developing Okapi core.

The module supports a `GET` request to `/hello`, which just returns the traditional greeting, in
plain text. It also supports a POST request, which accepts any JSON structure, and returns another,
more complex one.

## Files

There is only one source file:

* MainVerticle.java -- The "main program": an HTTP server that serves our requests.

There are JSON structures, ready to POST to Okapi for setting up a demonstration of this module.
They are generated by the build system from the templates in the "descriptors" directory.

* target/ModuleDescriptor.json -- A module description for the module.
* target/DeploymentDescriptor.json -- A module deployment descriptor for running the module under
    Okapi.
* target/TenantDescriptor.json -- To create a tenant for whom we can enable the module.
* target/TenantModuleDescriptor.json -- A small structure to enable the module for our test
    tenant.

Other noteworthy files are:

* Dockerfile -- Docker setup.
* pom.xml -- Maven config on how to build the project.
* log4j.properties -- Configuration for controlling the logging.
* README.md -- This file, explaining what is where and how to use the module.

## Compiling

```sh
mvn install
```

See that it says "BUILD SUCCESS" near the end.

## Docker

Build the docker container with:

```sh
docker build -t folio-hello-module .
```

Test that it runs with:

```sh
docker run -t -i -p 8080:8080 folio-hello-module
```

And check it in another window:

```sh
curl http://localhost:8080/hello
```

Now stop that test run.

## Installing the module

We are essentially following the
[Deploying Modules](https://github.com/folio-org/okapi/blob/master/doc/guide.md#example-1-deploying-and-using-a-simple-module)
sections of the Okapi Guide and Reference, which describe the process in detail.

First of all you need a running Okapi instance. (Note that
[specifying](../README.md#setting-things-up) an explicit 'okapiurl' might be needed.)

```sh
cd .../okapi
java -jar okapi-core/target/okapi-core-fat.jar dev
```

Since we just started Okapi, we have no tenants defined. So let's make one:

```sh
curl -w '\n' -X POST -D - \
    -H "Content-type: application/json" \
    -d @target/TenantDescriptor.json \
    http://localhost:9130/_/proxy/tenants
```

We need to declare the module to Okapi:

```sh
curl -w '\n' -X POST -D - \
   -H "Content-type: application/json" \
   -d @target/ModuleDescriptor.json \
   http://localhost:9130/_/proxy/modules
```

That ModuleDescriptor tells Okapi what the module is called, what services it provides, and how to
deploy it.

## Deploying the module

Next we need to deploy the module. There is a deployment descriptor in
`target/DeploymentDescriptor.json`. It tells Okapi to start the module on `localhost`.

Please note that, on some Vagrant boxes, the node is not `localhost`. In this case, the current
node's name must be queried from Okapi:

```sh
curl -w '\n' -X GET \
    http://localhost:9130/_/discovery/nodes
```

This will result in a JSON file that shows all node IDs and their URLs. Pick the corresponding node
ID (if not localhost, usually an IP such as `10.0.2.15`) and place it into
`target/DeploymentDescriptor.json`.

Next, deploy it to the node via Okapi discovery:

```sh
curl -w '\n' -D - -s \
    -X POST \
    -H "Content-type: application/json" \
    -d @target/DeploymentDescriptor.json \
    http://localhost:9130/_/discovery/modules
```

The module should now be running on the next available port, e.g. 9131.

Check the running module:

```sh
curl -w '\n' -D - http://localhost:9131/hello
```

and see the container with `docker ps`

Then we need to enable the module for our test tenant:

```sh
curl -w '\n' -X POST -D - \
    -H "Content-type: application/json" \
    -d @target/TenantModuleDescriptor.json \
    http://localhost:9130/_/proxy/tenants/testlib/modules
```

## Using the module

```sh
curl -w '\n' -H "X-Okapi-Tenant: testlib" http://localhost:9130/hello
```

Or you can post any valid JSON, for example our enabling request:

```sh
curl -w '\n' -X POST -D - \
    -H "Content-type: application/json" \
    -H "X-Okapi-Tenant: testlib" \
    -d @target/TenantModuleDescriptor.json \
    http://localhost:9130/hello
```

## Restrict access

Follow the
[auth-module](https://github.com/folio-org/okapi/blob/master/doc/guide.md#example-2-adding-the-auth-module)
section of the Okapi Guide and Reference.

## Cleaning up

### Disable the module for the tenant

```sh
curl -w '\n' -X DELETE -D - \
    http://localhost:9130/_/proxy/tenants/testlib/modules/folio-hello-vertx-0.1-SNAPSHOT
```

### Undeploy the module

When deployed using Okapi discovery, the `POST` request to `/_/discovery/modules` will have returned
an instance ID, such as `localhost-9131` or `afa41ba6-b391-4532-8070-3d5762bb68b7`. If you did not
make a note of this ID, you can use:

```sh
curl -w '\n' -X GET \
    http://localhost:9130/_/discovery/modules/folio-hello-vertx-0.1-SNAPSHOT
```

This will list all running instances of `folio-hello-vertx-0.1-SNAPSHOT` (it is possible to have
multiple if it is deployed to Okapi discovery multiple times). From there, you can use:

```sh
curl -w '\n' -X DELETE -D - \
    http://localhost:9130/_/discovery/modules/folio-hello-vertx-0.1-SNAPSHOT/{instance-id}
```

For example:

```sh
curl -w '\n' -X DELETE -D - \
    http://localhost:9130/_/discovery/modules/folio-hello-vertx-0.1-SNAPSHOT/localhost-9131

```

This will stop the running instance of the module, however that may apply (in this case, by stopping
and removing the Docker container).

### Undeclaring the module

```sh
curl -w '\n' -X DELETE -D - \
    http://localhost:9130/_/proxy/modules/folio-hello-vertx-0.1-SNAPSHOT
```

Finally you can stop the Okapi, with a Ctrl-C in its terminal window.

## Scripting it

There is a little shell script to go through the setting up, as above. It is called 'runhello.sh'.
Please be advised that this may not work on all environments, including the provided Vagrant boxes.

## What next

As such this module is pretty useless. You can use it to understand what a FOLIO module is, and as
an example, or even as a starting point, for creating your own modules. You may want to look at the
slightly more complex module called `simple-vertx`, and maybe reread the Okapi Guide.
